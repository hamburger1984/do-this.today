<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Dice Debug Test</title>
    <style>
      :root {
        /* Color Palette */
        --teal: #2d8486;
        --sandy-brown: #fcaa67;
        --redwood: #b0413e;
        --cream: #ffffc7;
        --van-dyke: #473335;

        /* Additional Colors */
        --white: #ffffff;
        --black: #000000;

        /* Background Colors */
        --bg-light: #fefef3;
        --bg-lighter: var(--cream);

        /* Border Colors */
        --border-light: #f0e6b3;
        --border-medium: #e6d999;

        /* Text Colors */
        --text-secondary: #6b4d4f;
        --text-muted: #8a6e71;

        /* Alpha/Opacity Colors */
        --primary-alpha-10: rgba(45, 132, 134, 0.1);
        --primary-alpha-40: rgba(45, 132, 134, 0.4);
        --success-alpha-10: rgba(45, 132, 134, 0.1);
        --error-alpha-10: rgba(176, 65, 62, 0.1);
        --secondary-alpha-10: rgba(252, 170, 103, 0.1);
        --black-alpha-10: rgba(71, 51, 53, 0.1);
        --black-alpha-30: rgba(0, 0, 0, 0.2);
      }
      body {
        font-family: system-ui, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background: linear-gradient(
          135deg,
          var(--teal, #2d8486) 0%,
          var(--sandy-brown, #fcaa67) 100%
        );
        min-height: 100vh;
      }
      .container {
        background: var(--white, white);
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 10px 25px var(--black-alpha-30, rgba(0, 0, 0, 0.2));
      }
      h1 {
        color: var(--teal, #2d8486);
        text-align: center;
        margin-bottom: 2rem;
      }
      .button {
        background: linear-gradient(
          135deg,
          var(--teal, #2d8486) 0%,
          var(--sandy-brown, #fcaa67) 100%
        );
        color: var(--white, white);
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        margin: 10px;
        font-weight: 600;
      }
      .button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--primary-alpha-40, rgba(45, 132, 134, 0.4));
      }
      .output {
        background: var(--bg-light, #fefef3);
        border: 1px solid var(--border-light, #f0e6b3);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        white-space: pre-wrap;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .status {
        padding: 0.5rem 1rem;
        border-radius: 4px;
        margin: 0.5rem 0;
        font-weight: 500;
      }
      .status.ok {
        background: var(--success-alpha-10, rgba(45, 132, 134, 0.1));
        color: var(--teal, #2d8486);
      }
      .status.warning {
        background: var(--secondary-alpha-10, rgba(252, 170, 103, 0.1));
        color: var(--sandy-brown, #fcaa67);
      }
      .status.error {
        background: var(--error-alpha-10, rgba(176, 65, 62, 0.1));
        color: var(--redwood, #b0413e);
      }
      .info {
        background: var(--bg-light, #fefef3);
        border-left: 4px solid var(--teal, #2d8486);
        padding: 1rem;
        margin: 1rem 0;
      }
      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin: 2rem 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üîß Task Dice Debug & Recovery Tool</h1>

      <div class="info">
        <h3>About This Tool</h3>
        <p>
          If you're seeing "[object Object]" in your task list, this tool can
          help diagnose and fix the issue. This happens when task data gets
          corrupted in your browser's storage.
        </p>
      </div>

      <div class="actions">
        <button class="button" onclick="checkData()">
          üîç Check Data Integrity
        </button>
        <button class="button" onclick="cleanupData()">
          üßπ Clean Corrupted Data
        </button>
        <button class="button" onclick="exportData()">
          üíæ Export Data Backup
        </button>
        <button class="button" onclick="clearAllData()">
          üóëÔ∏è Clear All Data
        </button>
      </div>

      <div id="status"></div>
      <div id="output" class="output" style="display: none"></div>

      <div class="info">
        <h3>Instructions:</h3>
        <ol>
          <li>
            <strong>Check Data Integrity</strong> - Scans your saved tasks for
            problems
          </li>
          <li>
            <strong>Clean Corrupted Data</strong> - Removes any corrupted task
            entries
          </li>
          <li>
            <strong>Export Data Backup</strong> - Downloads your tasks as JSON
            for safekeeping
          </li>
          <li>
            <strong>Clear All Data</strong> - Nuclear option: removes all data
            and starts fresh
          </li>
        </ol>
      </div>
    </div>

    <script>
      function showStatus(message, type = "ok") {
        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
      }

      function showOutput(content) {
        const outputDiv = document.getElementById("output");
        outputDiv.textContent = content;
        outputDiv.style.display = "block";
      }

      function checkData() {
        try {
          const tasks = localStorage.getItem("nowwhat-tasks");
          const deleted = localStorage.getItem("nowwhat-deleted");

          let report = "DATA INTEGRITY REPORT\n";
          report += "========================\n\n";

          let issues = 0;

          if (!tasks) {
            report += "‚úÖ No task data found (fresh install)\n";
          } else {
            try {
              const taskData = JSON.parse(tasks);
              report += `üìã Found ${taskData.length} tasks\n\n`;

              taskData.forEach((task, index) => {
                if (!task || typeof task !== "object") {
                  report += `‚ùå Task ${index}: Invalid object\n`;
                  issues++;
                } else {
                  if (typeof task.text !== "string") {
                    report += `‚ùå Task ${index}: Text is not string (${typeof task.text})\n`;
                    issues++;
                  }
                  if (!["oneoff", "repeatable"].includes(task.type)) {
                    report += `‚ö†Ô∏è  Task ${index}: Invalid type "${task.type}"\n`;
                    issues++;
                  }
                  if (!Array.isArray(task.executions)) {
                    report += `‚ö†Ô∏è  Task ${index}: Executions is not array\n`;
                    issues++;
                  }
                }
              });
            } catch (parseError) {
              report += `‚ùå CRITICAL: Cannot parse task data - ${parseError.message}\n`;
              issues++;
            }
          }

          if (deleted) {
            try {
              const deletedData = JSON.parse(deleted);
              report += `\nüóëÔ∏è Found ${deletedData.length} deleted tasks\n`;

              deletedData.forEach((task, index) => {
                if (!task || typeof task !== "object") {
                  report += `‚ùå Deleted task ${index}: Invalid object\n`;
                  issues++;
                } else if (typeof task.text !== "string") {
                  report += `‚ùå Deleted task ${index}: Text is not string\n`;
                  issues++;
                }
              });
            } catch (parseError) {
              report += `‚ùå CRITICAL: Cannot parse deleted task data - ${parseError.message}\n`;
              issues++;
            }
          }

          report += `\n\nSUMMARY: ${issues} issues found\n`;

          if (issues === 0) {
            showStatus("‚úÖ No data integrity issues found!", "ok");
          } else {
            showStatus(
              `‚ö†Ô∏è Found ${issues} data integrity issues. Check output for details.`,
              "warning",
            );
          }

          showOutput(report);
        } catch (error) {
          showStatus(`‚ùå Error checking data: ${error.message}`, "error");
          showOutput(`Error details:\n${error.stack}`);
        }
      }

      function cleanupData() {
        if (!confirm("This will remove corrupted task entries. Continue?")) {
          return;
        }

        try {
          let cleaned = false;
          let report = "CLEANUP REPORT\n";
          report += "===============\n\n";

          // Clean tasks
          const tasks = localStorage.getItem("nowwhat-tasks");
          if (tasks) {
            const taskData = JSON.parse(tasks);
            const originalCount = taskData.length;

            const cleanTasks = taskData.filter((task, index) => {
              const valid =
                task &&
                typeof task === "object" &&
                typeof task.text === "string";
              if (!valid) {
                report += `üßπ Removed corrupted task at index ${index}\n`;
                cleaned = true;
              }
              return valid;
            });

            if (cleanTasks.length !== originalCount) {
              localStorage.setItem("nowwhat-tasks", JSON.stringify(cleanTasks));
              report += `üìã Tasks: ${originalCount} ‚Üí ${cleanTasks.length}\n`;
            } else {
              report += `üìã Tasks: All ${originalCount} tasks were valid\n`;
            }
          }

          // Clean deleted tasks
          const deleted = localStorage.getItem("nowwhat-deleted");
          if (deleted) {
            const deletedData = JSON.parse(deleted);
            const originalCount = deletedData.length;

            const cleanDeleted = deletedData.filter((task, index) => {
              const valid =
                task &&
                typeof task === "object" &&
                typeof task.text === "string";
              if (!valid) {
                report += `üßπ Removed corrupted deleted task at index ${index}\n`;
                cleaned = true;
              }
              return valid;
            });

            if (cleanDeleted.length !== originalCount) {
              localStorage.setItem(
                "nowwhat-deleted",
                JSON.stringify(cleanDeleted),
              );
              report += `üóëÔ∏è Deleted tasks: ${originalCount} ‚Üí ${cleanDeleted.length}\n`;
            } else {
              report += `üóëÔ∏è Deleted tasks: All ${originalCount} tasks were valid\n`;
            }
          }

          if (cleaned) {
            report +=
              "\n‚úÖ Cleanup completed! Please refresh your Task Dice app.\n";
            showStatus("‚úÖ Corrupted data cleaned successfully!", "ok");
          } else {
            report += "\n‚úÖ No corrupted data found to clean.\n";
            showStatus("‚úÖ No corrupted data found.", "ok");
          }

          showOutput(report);
        } catch (error) {
          showStatus(`‚ùå Error during cleanup: ${error.message}`, "error");
          showOutput(`Error details:\n${error.stack}`);
        }
      }

      function exportData() {
        try {
          const data = {
            tasks: localStorage.getItem("nowwhat-tasks"),
            deleted: localStorage.getItem("nowwhat-deleted"),
            completed: localStorage.getItem("nowwhat-completed"),
            active: localStorage.getItem("nowwhat-active"),
            nextid: localStorage.getItem("nowwhat-nextid"),
            exported: new Date().toISOString(),
          };

          const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: "application/json",
          });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `nowwhat-backup-${new Date().toISOString().split("T")[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          showStatus("‚úÖ Data exported successfully!", "ok");
          showOutput(
            "Your data has been downloaded as a JSON file. Keep this safe as a backup!",
          );
        } catch (error) {
          showStatus(`‚ùå Error exporting data: ${error.message}`, "error");
        }
      }

      function clearAllData() {
        if (
          !confirm(
            "‚ö†Ô∏è WARNING: This will permanently delete ALL your tasks and data. Are you sure?",
          )
        ) {
          return;
        }

        if (
          !confirm(
            "This action cannot be undone. Please confirm you want to delete everything.",
          )
        ) {
          return;
        }

        try {
          localStorage.removeItem("nowwhat-tasks");
          localStorage.removeItem("nowwhat-deleted");
          localStorage.removeItem("nowwhat-completed");
          localStorage.removeItem("nowwhat-active");
          localStorage.removeItem("nowwhat-nextid");

          showStatus("‚úÖ All data cleared successfully!", "ok");
          showOutput(
            "All Task Dice data has been removed from your browser.\nThe app will start fresh when you next open it.",
          );
        } catch (error) {
          showStatus(`‚ùå Error clearing data: ${error.message}`, "error");
        }
      }

      // Auto-run integrity check on page load
      window.addEventListener("load", () => {
        setTimeout(checkData, 500);
      });
    </script>
  </body>
</html>
